<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basic Header Example</title>
    <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.0/qrious.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background-color: #f0f0f0;
        }
        nav a {
            margin: 0 15px;
            text-decoration: none;
            color: #333;
        }
        #preview {
            display: none;
            margin-top: 20px;
        }
        #preview img {
            width: 300px; /* Adjust width as needed */
            height: auto;
        }
        .button-container {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <a href="index.html">Home</a>
            <a href="picture.html">Picture</a>
            <a href="view.html">View</a>
        </nav>
        <img src="your-image-source.jpg" alt="Description of Image" width="50" height="50">
    </header>

    <h1>Photobooth </h1>
    <div>
        <h1>Take Pic</h1>
        <video id="video" width="300" height="200" autoplay></video>
        <button id="captureButton">Capture Image</button>
    </div>

    <div id="preview">
        <h2>Preview</h2>
        <img id="capturedImage" src="" alt="Captured Image">
        <div class="button-container">
            <button id="yesButton">Yes</button>
            <button id="noButton">No</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCWhzMHSSNyBJILjy0ELy2WCdiwjc84SJ8",
        authDomain: "photobooth-sss.firebaseapp.com",
        databaseURL: "https://photobooth-sss-default-rtdb.firebaseio.com/",
        projectId: "photobooth-sss",
        storageBucket: "photobooth-sss.appspot.com",
        messagingSenderId: "893599274396",
        appId: "1:893599274396:web:a1454f34acbd380890a459",
        measurementId: "G-3B9BXBCZPG"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const canvas = document.createElement('canvas');
    const captureButton = document.getElementById('captureButton');
    const preview = document.getElementById('preview');
    const capturedImage = document.getElementById('capturedImage');
    const yesButton = document.getElementById('yesButton');
    const noButton = document.getElementById('noButton');
    const video = document.getElementById('video');

    // Access the webcam
    navigator.mediaDevices.getUserMedia({ video: true })
        .then((stream) => {
            video.srcObject = stream;
        })
        .catch((error) => {
            console.error("Error accessing webcam:", error);
        });

    // Capture image event listener
    captureButton.addEventListener('click', async () => {
        const context = canvas.getContext('2d');
        canvas.width = 300;
        canvas.height = 200;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageDataUrl = canvas.toDataURL('image/png');

        // Show preview of the captured image
        capturedImage.src = imageDataUrl;
        preview.style.display = 'block'; // Show the preview div
    });

    // Yes button event listener
    yesButton.addEventListener('click', async () => {
        const uniqueId = Date.now();
        const newItemRef = ref(database, 'items/' + uniqueId);
        await set(newItemRef, { image_url: capturedImage.src });
        alert('Image captured and added successfully!');

        // Create a URL for viewing the image based on the unique ID
	const viewImageUrl = `https://photobooth-sss.firebaseapp.com/viewImage.html?id=${uniqueId}`;

        // Generate the QR code
        const qrCode = await generateQRCode(viewImageUrl);

        // Store the QR code in the database
        const newQRRef = ref(database, 'qr/' + uniqueId);
        await set(newQRRef, { qr_url: qrCode });

        preview.style.display = 'none'; // Hide the preview div
    });

    // No button event listener
    noButton.addEventListener('click', () => {
        alert('Image capture cancelled. No data added to the database.');
        preview.style.display = 'none'; // Hide the preview div
    });

    // QR code generation function
    async function generateQRCode(data) {
        alert("Generating QR code");
        try {
            const qrCode = new QRCodeStyling({
                width: 150,
                height: 150,
                type: "svg",
                data: data,
                dotsOptions: { color: "#4267b2", type: "rounded" },
                backgroundOptions: { color: "#e9ebee" },
                imageOptions: { crossOrigin: "anonymous", margin: 10 }
            });

            // Create a temporary container for the QR code
            const container = document.createElement('div');
            await qrCode.append(container); // This will render the QR code in the container

            // Convert the SVG content to a data URL
            const svgElement = container.querySelector('svg');
            const dataURL = new XMLSerializer().serializeToString(svgElement);
            const base64Data = btoa(dataURL);
            alert("QR code generated successfully");
            return `data:image/svg+xml;base64,${base64Data}`; // Return the data URL
        } catch (error) {
            alert("Error generating QR code: " + error.message);
            console.error("Error generating QR code:", error);
            throw new Error("QR Code Generation Failed");
        }
    }
</script>
</body>
</html>
